#!/bin/bash

# Pre-commit hook for vmspawn
#
# Install with:
#   git config core.hooksPath hooks
# Or:
#   ln -sf ../../hooks/pre-commit .git/hooks/pre-commit

set -eu

staged=$(git diff --cached --name-only --diff-filter=d)
[[ -z "$staged" ]] && exit 0

errors=0
run_tests=0
yaml_files=()
md_files=()

while IFS= read -r f ; do
    case "$f" in
        vmspawn|templates/*|helpers/*|tests/*.bats|tests/helpers.bash)
            run_tests=1 ;;
        helpers/*.yaml)
            yaml_files+=("$f") ;;
        *.md)
            md_files+=("$f") ;;
    esac
done <<< "$staged"

if ((run_tests)) ; then
    if type -p bats &>/dev/null ; then
        echo "pre-commit: running bats tests..."
        bats tests/ || { echo "pre-commit: bats FAILED"; ((errors++)); }
    else
        echo "pre-commit: WARNING -- bats not found, skipping tests"
    fi
fi

if ((${#yaml_files[@]})) ; then
    if type -p yamllint &>/dev/null ; then
        echo "pre-commit: yamllint (${#yaml_files[@]} file(s))..."
        yamllint "${yaml_files[@]}" || { echo "pre-commit: yamllint FAILED"; ((errors++)); }
    else
        echo "pre-commit: WARNING -- yamllint not found"
    fi
fi

if ((${#md_files[@]})) ; then
    if type -p markdownlint-cli2 &>/dev/null ; then
        echo "pre-commit: markdownlint (${#md_files[@]} file(s))..."
        markdownlint-cli2 "${md_files[@]}" || { echo "pre-commit: markdownlint FAILED"; ((errors++)); }
    else
        echo "pre-commit: WARNING -- markdownlint-cli2 not found"
    fi
fi

if ((errors)) ; then
    echo -e "\npre-commit: $errors check(s) failed -- commit aborted"
    exit 1
fi

echo "pre-commit: all checks passed"
